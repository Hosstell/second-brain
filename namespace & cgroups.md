–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä —Ç–µ–º—ã!¬†**Namespace –∏ cgroups**¬†‚Äî —ç—Ç–æ –∫–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –≤ Linux –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö Docker).
–í–æ—Ç –Ω–∞–±–æ—Ä –∑–∞–¥–∞–Ω–∏–π –æ—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ –∫ —Å–ª–æ–∂–Ω–æ–º—É:

---
### **üîπ –£—Ä–æ–≤–µ–Ω—å 1: –û—Å–Ω–æ–≤—ã Namespace**

1. **–ü—Ä–æ—Å—Ç–µ–π—à–∏–π namespace**
    
    - –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π¬†**PID namespace**¬†—Å –ø–æ–º–æ—â—å—é¬†`unshare --pid --fork`¬†–∏ –ø—Ä–æ–≤–µ—Ä—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (`ps aux`). –ü–æ—á–µ–º—É –≤–∏–¥–∏—à—å –Ω–µ –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã?
        
    - –ó–∞–ø—É—Å—Ç–∏¬†`bash`¬†–≤ –Ω–æ–≤–æ–º namespace –∏ –ø–æ–ø—Ä–æ–±—É–π –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫–∞–∫–æ–π-–Ω–∏–±—É–¥—å "—á—É–∂–æ–π" –ø—Ä–æ—Ü–µ—Å—Å. –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?
        
2. **–°–µ—Ç–µ–≤–æ–π namespace**
    
    - –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π¬†**network namespace**¬†(`ip netns add testns`).
        
    - –ü—Ä–æ–≤–µ—Ä—å —Å–ø–∏—Å–æ–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ (`ip link`). –ü–æ—á–µ–º—É –Ω–µ—Ç¬†`eth0`?
        
    - –î–æ–±–∞–≤—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (`ip link add veth0 type veth peer name veth1`) –∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏ –æ–¥–∏–Ω –∫–æ–Ω–µ—Ü –≤ –Ω–æ–≤—ã–π namespace.
        

---

### **üîπ –£—Ä–æ–≤–µ–Ω—å 2: –†–∞–±–æ—Ç–∞ —Å cgroups (v2)**

3. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ CPU**
    
    - –°–æ–∑–¥–∞–π cgroup¬†`cpu_test`¬†(`sudo mkdir /sys/fs/cgroup/cpu_test`).
        
    - –£—Å—Ç–∞–Ω–æ–≤–∏ –ª–∏–º–∏—Ç CPU –≤ 50% (`echo 50000 > cpu.cfs_quota_us`).
        
    - –ó–∞–ø—É—Å—Ç–∏ —Å—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç (`stress --cpu 1`) –∏ –¥–æ–±–∞–≤—å –µ–≥–æ PID –≤ cgroup. –ü—Ä–æ–≤–µ—Ä—å –Ω–∞–≥—Ä—É–∑–∫—É (`htop`).
        
4. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏**
    
    - –°–æ–∑–¥–∞–π cgroup¬†`memory_test`¬†–∏ —É—Å—Ç–∞–Ω–æ–≤–∏ –ª–∏–º–∏—Ç –≤ 100 –ú–ë.
        
    - –ó–∞–ø—É—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–¥–µ–ª—è–µ—Ç –º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä,¬†`tail /dev/zero`), –∏ –¥–æ–±–∞–≤—å –µ–≥–æ –≤ cgroup. –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç?
        

---

### **üîπ –£—Ä–æ–≤–µ–Ω—å 3: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Namespace –∏ cgroups**

5. **–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Ä—É—á–Ω—É—é**
    
    - –°–æ–∑–¥–∞–π –ø—Ä–æ—Ü–µ—Å—Å –≤ –Ω–æ–≤—ã—Ö¬†**PID, UTS, IPC –∏ network namespace**¬†(`unshare --pid --uts --ipc --net --fork`).
        
    - –û–≥—Ä–∞–Ω–∏—á—å –µ–≥–æ CPU –∏ –ø–∞–º—è—Ç—å —á–µ—Ä–µ–∑ cgroups.
        
    - –ü–æ–ø—Ä–æ–±—É–π —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å¬†`/proc`¬†–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã (`mount -t proc proc /proc`).
        
6. **–ê–Ω–∞–ª–æ–≥ Docker (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)**
    
    - –ù–∞–ø–∏—à–∏ —Å–∫—Ä–∏–ø—Ç –Ω–∞ bash, –∫–æ—Ç–æ—Ä—ã–π:
        
        - –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ namespaces.
            
        - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (NAT).
            
        - –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã —á–µ—Ä–µ–∑ cgroups.
            
        - –ó–∞–ø—É—Å–∫–∞–µ—Ç¬†`/bin/bash`¬†–≤ —ç—Ç–æ–π "–ø–µ—Å–æ—á–Ω–∏—Ü–µ".
            

---

### **üîπ –£—Ä–æ–≤–µ–Ω—å 4: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏**

7. **User namespace –∏ –ø—Ä–∞–≤–∞ root**
    
    - –°–æ–∑–¥–∞–π¬†**user namespace**¬†(`unshare --user --map-root-user`).
        
    - –ü–æ–ø—Ä–æ–±—É–π —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ-—Ç–æ –æ—Ç –∏–º–µ–Ω–∏ root (–Ω–∞–ø—Ä–∏–º–µ—Ä,¬†`mount`). –ü–æ—á–µ–º—É –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è? –ö–∞–∫ —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?
        
8. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ cgroups**
    
    - –ó–∞–ø—É—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å, –¥–æ–±–∞–≤—å –µ–≥–æ –≤ cgroup —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º CPU, –∞ –∑–∞—Ç–µ–º¬†**–Ω–∞ –ª–µ—Ç—É**¬†–∏–∑–º–µ–Ω–∏ –∫–≤–æ—Ç—É. –ö–∞–∫ —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å?
        
9. **–û—Ç–ª–∞–¥–∫–∞ –∏–∑–æ–ª—è—Ü–∏–∏**
    
    - –ó–∞–ø—É—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º namespace, –Ω–æ –æ—Å—Ç–∞–≤—å –µ–º—É –¥–æ—Å—Ç—É–ø –∫¬†`/sys`¬†–∏–ª–∏¬†`/proc`. –ö–∞–∫ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø–∞—Å–Ω–æ?
        

---

### **üîπ –ë–æ–Ω—É—Å (–¥–ª—è —ç–∫—Å–ø–µ—Ä—Ç–æ–≤)**

10. **–°–≤–æ—è –º–∏–Ω–∏-–≤–µ—Ä—Å–∏—è Docker**
    
    - –ù–∞–ø–∏—à–∏ –ø—Ä–æ–≥—Ä–∞–º–º—É –Ω–∞ C/Python/Go, –∫–æ—Ç–æ—Ä–∞—è:
        
        - –°–æ–∑–¥–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ namespaces.
            
        - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç cgroups –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤.
            
        - –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –≤ —ç—Ç–æ–π –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ä–µ–¥–µ.
            

---

–ö–∞–∂–¥–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ–º–æ–∂–µ—Ç –≥–ª—É–±–∂–µ –ø–æ–Ω—è—Ç—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –∏–∑–æ–ª—è—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏ –≤ Linux. –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π! üöÄ

–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∞ unshare

–ü—Ä–æ–≥—Ä–∞–º–º–∞¬†**`unshare`**¬†–≤ Linux –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –≤ –Ω–æ–≤—ã—Ö¬†**namespace'–∞—Ö**, –∏–∑–æ–ª–∏—Ä—É—è –µ–≥–æ –æ—Ç –æ—Å—Ç–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –≠—Ç–æ –∫–ª—é—á–µ–≤–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–∫–∞–∫ –≤ Docker) –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–ª—è—Ü–∏–µ–π –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

### üîπ¬†**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç¬†`unshare`?**

- –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ¬†**namespace'—ã**¬†–¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ (–∏–ª–∏ –≥—Ä—É–ø–ø—ã –ø—Ä–æ—Ü–µ—Å—Å–æ–≤), –æ—Ç–¥–µ–ª—è—è –µ–≥–æ –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã.
    
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å:
    
    - **PID**¬†(–ø—Ä–æ—Ü–µ—Å—Å—ã),
        
    - **Network**¬†(—Å–µ—Ç—å),
        
    - **UTS**¬†(hostname –∏ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è),
        
    - **IPC**¬†(–º–µ–∂–ø—Ä–æ—Ü–µ—Å—Å–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ),
        
    - **Mount**¬†(—Ñ–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã),
        
    - **User**¬†(–ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è),
        
    - **Cgroup**¬†(–≥—Ä—É–ø–ø—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏).
        

---

### üîπ¬†**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–ª–∞–≥–∏¬†`unshare`**

|–§–ª–∞–≥|Namespace|–ß—Ç–æ –∏–∑–æ–ª–∏—Ä—É–µ—Ç|
|---|---|---|
|`--pid`|PID|–°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏).|
|`--net`|Network|–°–µ—Ç–µ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏.|
|`--uts`|UTS|Hostname –∏ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è.|
|`--ipc`|IPC|–ú–µ–∂–ø—Ä–æ—Ü–µ—Å—Å–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ (–æ—á–µ—Ä–µ–¥–∏ SysV, shared memory).|
|`--mount`|Mount|–§–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã (–º–æ–∂–Ω–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å¬†`/`,¬†`/proc`¬†–∏ —Ç. –¥.).|
|`--user`|User|UID/GID (–º–æ–∂–Ω–æ –±—ã—Ç—å "root" –≤–Ω—É—Ç—Ä–∏ –±–µ–∑ –ø—Ä–∞–≤ —Å–Ω–∞—Ä—É–∂–∏).|
|`--cgroup`|Cgroup|–ì—Ä—É–ø–ø—ã cgroups (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ CPU, –ø–∞–º—è—Ç–∏ –∏ –¥—Ä.).|
|`--fork`|‚Äî|–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –≤ —Ñ–æ–Ω–µ (–∏–Ω–∞—á–µ –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å¬†`--pid`).|

---

### üîπ¬†**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**

#### 1.¬†**–ó–∞–ø—É—Å–∫¬†`bash`¬†–≤ –Ω–æ–≤–æ–º PID namespace (–∏–∑–æ–ª—è—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤)**

bash

Copy

sudo unshare --pid --fork bash
ps aux  # —É–≤–∏–¥–∏—à—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã

- –ó–¥–µ—Å—å¬†`ps aux`¬†–ø–æ–∫–∞–∂–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –≤–Ω—É—Ç—Ä–∏ namespace (–æ–±—ã—á–Ω–æ –ø—É—Å—Ç–æ, –ø–æ–∫–∞ –Ω–µ —Å–º–æ–Ω—Ç–∏—Ä—É–µ—à—å¬†`/proc`).
    

#### 2.¬†**–ò–∑–º–µ–Ω–µ–Ω–∏–µ hostname –≤ –Ω–æ–≤–æ–º UTS namespace**

bash

Copy

sudo unshare --uts bash
hostname my-new-hostname  # –º–µ–Ω—è–µ–º hostname —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏
hostname  # –ø—Ä–æ–≤–µ—Ä–∏–º
exit
hostname  # —Å–Ω–∞—Ä—É–∂–∏ –æ—Å—Ç–∞–ª–æ—Å—å –ø—Ä–µ–∂–Ω–∏–º

#### 3.¬†**–°–æ–∑–¥–∞–Ω–∏–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–µ—Ç–µ–≤–æ–π —Å—Ä–µ–¥—ã**

bash

Copy

sudo unshare --net bash
ip link  # —É–≤–∏–¥–∏—à—å —Ç–æ–ª—å–∫–æ loopback-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

- –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–µ—Ç—å, –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å¬†`veth`¬†–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å¬†`bridge`.
    

#### 4.¬†**–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ namespace'–æ–≤ (–∞–Ω–∞–ª–æ–≥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)**

bash

Copy

sudo unshare --pid --uts --ipc --net --mount --fork bash

–¢–µ–ø–µ—Ä—å –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø–æ—á—Ç–∏ –ø–æ–ª–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏ (–∫–∞–∫ –≤ Docker).

---

### üîπ¬†**–û—Ç–ª–∏—á–∏–µ –æ—Ç¬†`clone()`¬†–∏¬†`setns()`**

- `unshare`¬†‚Äî¬†**—Ä–∞–∑–¥–µ–ª—è–µ—Ç**¬†namespace'—ã (–æ—Ç–≤—è–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç —Ç–µ–∫—É—â–∏—Ö).
    
- `clone()`¬†‚Äî¬†**—Å–æ–∑–¥–∞–µ—Ç**¬†–ø—Ä–æ—Ü–µ—Å—Å –≤ –Ω–æ–≤—ã—Ö namespace'–∞—Ö (–∫–∞–∫ –¥–µ–ª–∞–µ—Ç Docker).
    
- `setns()`¬†‚Äî¬†**–ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—Ç**¬†–ø—Ä–æ—Ü–µ—Å—Å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É namespace.
    

---

### üîπ¬†**–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ**

- **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã**¬†(Docker, LXC) –∏—Å–ø–æ–ª—å–∑—É—é—Ç¬†`unshare`¬†–¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.
    
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º –≤ –ø–µ—Å–æ—á–Ω–∏—Ü–µ.
    
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ò–∑–æ–ª—è—Ü–∏—è —Å–µ—Ç–µ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫, —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º.
    

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –≥–ª—É–±–∂–µ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, –º–æ–∂–µ—à—å –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –º–∏–Ω–∏-"–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä" –Ω–∞ –æ—Å–Ω–æ–≤–µ¬†`unshare`¬†+¬†`cgroups`! üöÄ

–î–∞–≤–∞–π

–û—Ç–ª–∏—á–Ω–æ! –î–∞–≤–∞–π —Å–¥–µ–ª–∞–µ–º¬†**–º–∏–Ω–∏-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä**¬†–Ω–∞ –æ—Å–Ω–æ–≤–µ¬†`unshare`¬†–∏¬†`cgroups`, –∫–∞–∫ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–æ–≥ Docker. –ú—ã –∏–∑–æ–ª–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö namespace'–∞—Ö –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–º –µ–≥–æ —Ä–µ—Å—É—Ä—Å—ã.

---

## üîπ¬†**1. –°–æ–∑–¥–∞–µ–º –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ä–µ–¥—É —Å¬†`unshare`**

–ó–∞–ø—É—Å—Ç–∏–º¬†`bash`¬†–≤ –Ω–æ–≤—ã—Ö namespace'–∞—Ö (PID, UTS, Network, Mount, IPC):

bash

Copy

sudo unshare --pid --uts --ipc --net --mount --fork --cgroup --user bash

–¢–µ–ø–µ—Ä—å –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø–æ—á—Ç–∏ –ø–æ–ª–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏.

### –ß—Ç–æ –º—ã —Å–¥–µ–ª–∞–ª–∏:

|–§–ª–∞–≥|–≠—Ñ—Ñ–µ–∫—Ç|
|---|---|
|`--pid`|–í–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã.|
|`--uts`|–ú–æ–∂–µ—Ç –ø–æ–º–µ–Ω—è—Ç—å¬†`hostname`¬†–±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Å–∏—Å—Ç–µ–º—É.|
|`--ipc`|–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –∏ –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.|
|`--net`|–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω–µ—à–Ω–µ–π —Å–µ—Ç–∏ (—Ç–æ–ª—å–∫–æ¬†`lo`).|
|`--mount`|–ú–æ–∂–µ—Ç –º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ —Ñ–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã.|
|`--cgroup`|–ú–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å CPU/–ø–∞–º—è—Ç—å.|
|`--user`|–ë—É–¥–µ—Ç "root" –≤–Ω—É—Ç—Ä–∏, –Ω–æ –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–Ω–∞—Ä—É–∂–∏.|

---

## üîπ¬†**2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É**

–í–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω—É–∂–Ω–æ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å¬†`/proc`, –∏–Ω–∞—á–µ¬†`ps`,¬†`top`¬†–Ω–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å:

bash

Copy

mount -t proc proc /proc

–¢–µ–ø–µ—Ä—å¬†`ps aux`¬†–ø–æ–∫–∞–∂–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã¬†**—Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**.

---

## üîπ¬†**3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–µ—Ç—å (–∫–∞–∫ –≤ Docker)**

–°–µ–π—á–∞—Å —É –Ω–∞—Å —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å¬†`lo`. –î–∞–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –¥–æ—Å—Ç—É–ø –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —á–µ—Ä–µ–∑ NAT.

### –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é —Å–µ—Ç—å:

(–í—ã–ø–æ–ª–Ω—è–µ–º¬†**–≤ –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ**, –Ω–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ!)

bash

Copy

# –°–æ–∑–¥–∞–µ–º veth-–ø–∞—Ä—É (veth0 - –≤–Ω–µ—à–Ω–∏–π, veth1 - –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
sudo ip link add veth0 type veth peer name veth1

# veth0 –ø–æ–¥–∫–ª—é—á–∞–µ–º –≤ bridge (–∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ netns)
sudo ip link set veth0 up
sudo ip addr add 10.0.0.1/24 dev veth0

# veth1 –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ namespace –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–Ω—É–∂–µ–Ω PID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
CONTAINER_PID=$(pgrep -f "unshare.*bash")  # –Ω–∞—Ö–æ–¥–∏–º PID
sudo ip link set veth1 netns $CONTAINER_PID

# –í–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–µ—Ç—å:
sudo nsenter -t $CONTAINER_PID -n ip link set veth1 up
sudo nsenter -t $CONTAINER_PID -n ip addr add 10.0.0.2/24 dev veth1
sudo nsenter -t $CONTAINER_PID -n ip route add default via 10.0.0.1

### –í–∫–ª—é—á–∞–µ–º NAT –Ω–∞ —Ö–æ—Å—Ç–µ:

bash

Copy

echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
sudo iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -j MASQUERADE

–¢–µ–ø–µ—Ä—å –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –º–æ–∂–Ω–æ –ø–∏–Ω–≥–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ (`ping 8.8.8.8`).

---

## üîπ¬†**4. –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã —á–µ—Ä–µ–∑ cgroups v2**

–°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º CPU –∏ –ø–∞–º—è—Ç—å:

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ CPU (50% —è–¥—Ä–∞):

bash

Copy

sudo mkdir /sys/fs/cgroup/cpu_limits
echo 50000 | sudo tee /sys/fs/cgroup/cpu_limits/cpu.cfs_quota_us  # 50% CPU
echo $CONTAINER_PID | sudo tee /sys/fs/cgroup/cpu_limits/cgroup.procs

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ (100 –ú–ë):

bash

Copy

sudo mkdir /sys/fs/cgroup/memory_limits
echo "100M" | sudo tee /sys/fs/cgroup/memory_limits/memory.max
echo $CONTAINER_PID | sudo tee /sys/fs/cgroup/memory_limits/cgroup.procs

–¢–µ–ø–µ—Ä—å, –µ—Å–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å¬†`stress --cpu 1 --vm 1 --vm-bytes 200M`, –ø—Ä–æ—Ü–µ—Å—Å –±—É–¥–µ—Ç —É–±–∏—Ç –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞.

---

## üîπ¬†**5. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ**

–¢–µ–ø–µ—Ä—å –≤–Ω—É—Ç—Ä–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ¬†`bash`¬†–º–æ–∂–Ω–æ:

- –ú–µ–Ω—è—Ç—å¬†`hostname`¬†(—ç—Ç–æ –Ω–µ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ —Ö–æ—Å—Ç).
    
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø–∞–∫–µ—Ç—ã (–µ—Å–ª–∏ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω¬†`/var/lib`).
    
- –ó–∞–ø—É—Å–∫–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä,¬†`python -m http.server 80`).
    

---

## üîπ¬†**6. –ß–∏—Å—Ç–∫–∞**

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã:

bash

Copy

# –£–¥–∞–ª—è–µ–º cgroups
sudo rmdir /sys/fs/cgroup/{cpu_limits,memory_limits}

# –£–¥–∞–ª—è–µ–º —Å–µ—Ç–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
sudo ip link del veth0
sudo iptables -t nat -D POSTROUTING -s 10.0.0.0/24 -j MASQUERADE

---

## üîπ¬†**–ò—Ç–æ–≥**

–ú—ã —Å–æ–∑–¥–∞–ª–∏ –∞–Ω–∞–ª–æ–≥ Docker, –∏—Å–ø–æ–ª—å–∑—É—è:

1. **`unshare`**¬†‚Äì –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —Å–µ—Ç–∏, —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã.
    
2. **`cgroups`**¬†‚Äì –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è CPU –∏ –ø–∞–º—è—Ç–∏.
    
3. **`veth`¬†+¬†`iptables`**¬†‚Äì –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∏.
    

–≠—Ç–æ –±–∞–∑–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã! –î–∞–ª—å—à–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

- OverlayFS –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤,
    
- `chroot`¬†–¥–ª—è –∫–æ—Ä–Ω–µ–≤–æ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã,
    
- –°–∫—Ä–∏–ø—Ç-–æ–±–µ—Ä—Ç–∫—É –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏.
    

–ü–æ–ø—Ä–æ–±—É–π –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å! –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –¥–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä–µ–º. üöÄ